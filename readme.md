
# 1С-запросы к базе для LLM-агентов

Это небольшое (буквально 20 строчек кода) расширение для 1С c HTTP-сервисом, который принимает на вход 1C-запрос и возвращает результат в виде таблицы с разделителями (TSV).

Изначально хотелось решить свою насущную проблему: как с LLM разбираться с задачами типа "Не проводится документ ... с ошибкой ...". Когда надо анализировать не только модуль проведения, а еще и с конкретными данными.

Получилось классно - [пример разбора проблемы от GPT Codex](docs\report01.md)

---

Побочным эффектом стало то, что теперь с помощью LLM агента можно получать любой анализ из базы. Особенно хорошо это работает с подключенным MCP по метаданным. В таком случае агент **сначала читает метаданные** и только **потом генерирует запрос**, что часто дает ваншотный результат. 
Строго говоря работает и без MCP, но дольше по времени и тратит сильно больше токенов. В 90% случаев первый запрос будет с ошибкой и следующим заходом LLMка пойдет вычитывать огромные xml'ки метаданных.

[Пример отчета из видео](docs\report02.md)

**На Инфостарт можно купить [MCP для метаданных](https://infostart.ru/marketplace/2460659/)**.

**Предупреждение:**
Вы должны понимать, что этим инструментом LLM'ка "сломать" в базе ничего не может, но "прочитает" ваши данные, включая персональные. Проблемы конфиденциальности - ваша ответственность. Можно использовать [обработки анонимизации данных от 1С](https://its.1c.ru/db/metod8dev/content/5863/hdoc) или навайбкодить свои.

## Ключевое в успехе решения

1. [Подробный SKILL](.claude\skills\1c-queries\SKILL.md), который минимизирует галлюцинации LLM. Даже через GLM 4.7 получаются хорошие запросы, с GPT 5.2 или Claude - вообще проблем нет.
2. Валидация синтаксиса запроса, которое подсмотрел в [публикации на Инфостарте](https://infostart.ru/1c/tools/2070895/). Это дает тот самый "Feedback loop", который позволяет агенту самому прийти к решению.
3. Не нужно заморачиваться сложной передачей параметров запроса, пусть LLM'ка сама хардкодит условия прямо в текст запроса через примитивные типы данных.

Формат ответа сознательно сделан в TSV, чтобы минимизировать токены. Удобнее было бы в JSON, но объем ответов резко возрастает. Таблицы с разделителями LLM'ка хорошо понимаю (обучались на куче логов в том числе).

## Быстрый старт

Разберем на примере демо-базы 1С УНФ, но работать должно на любой современной 1Ске.

1. Подключаем расширение [АПРО_ВнешниеЗапросы](build/АПРО_ВнешниеЗапросы%20-%201.03.cfe)
2. Публикуем HTTP-сервис
    - Если база клиент-серверная, то в [default.vrd](docs\default.vrd) добавляем блок:
    ```xml
    <httpServices publishExtensionsByDefault="true">
            <service name="АПРО_ВЗ_HTTPЗапросы"
                rootUrl="queries"
                enable="true"
                reuseSessions="autouse"
                sessionMaxAge="20"
                poolSize="10"
                poolTimeout="5"/>
        </httpServices>   
    ```
    - Если база файловая, то можно публиковать сервис через автономный сервер ibsrv. Например, такой командой в PowerShell:
    ```powershell
    & "C:\Program Files\1cv8\8.3.27.1786\bin\ibsrv.exe" --db-path="D:\1C_Bases\unf_demo_base" --config="D:\1C_Projects\unf_demo\publication.yaml" --http-address="any"
    ```
    где `publication.yaml` - [файл публикации](docs\publication.yaml) с таким содержимым:
    ```yaml
    http:
      - base: /
        http-services:
          service:
            - name: АПРО_ВЗ_HTTPЗапросы
              root: queries
              publish: true
    ```
3. Можно протестировать работу любым HTTP-клиентом. 
    - Для клиент-серверного варианта:
    ```bash
    # проверка что сервис работает
    curl --request GET \
    --url http://20.10.10.201/unf_demo/hs/queries/health \
    --header 'authorization: Basic YWRtaW46MTIz'
    ```
    - Для файлового варианта:
    ```bash
    # у автономного сервера 1С дефолтный порт 8314
    curl --request GET \
    --url http://localhost:8314/hs/queries/health \
    --header 'authorization: Basic YWRtaW46MTIz'
    ```
    - Пример полноценного запроса к базе:
    ```bash
    curl --request POST \
    --url http://20.10.10.201/unf_demo/hs/queries/query \
    --header 'authorization: Basic YWRtaW46MTIz' \
    --header 'content-type: application/json' \
    --data '{
    "query": "ВЫБРАТЬ
        ЧекККМ.Номер КАК Номер,
        ЧекККМ.Дата КАК Дата,
        ЧекККМ.Проведен КАК Проведен,
        ЧекККМ.Организация.Наименование КАК Организация
    ИЗ
        Документ.ЧекККМ КАК ЧекККМ
    ГДЕ
        ЧекККМ.Номер = \"ССНФ-000002\"
        И ЧекККМ.Дата >= ДАТАВРЕМЯ(2026, 1, 2)
        И ЧекККМ.Дата <= ДАТАВРЕМЯ(2026, 1, 3)"
    }'
    ```
    Не забывайте про Basic Auth в заголовках (под свое имя и пароль в базе 1С).
4. **Самое главное** - не забудьте **подправить [SKILL.md](.claude\skills\1c-queries\SKILL.md)** под свои данные:
    - свой url
    - свои логины/пароли

5. В каталоге своего проекта копируйте: `.claude\skills\1c-queries\SKILL.md`

**Все! Можно общаться с данными 1С через LLM агента!**

## Крутые альтернативные 1С-решения:
- [Remote API for Testing (RAT)](https://bia-technologies.github.io/rat/docs/functionality/) от БИАТЕХ и [Koryakin Aleksey](https://github.com/alkoleft)
- [Модуль от Сбера](https://platformv.sbertech.ru/docs/public/AM/1.10.0/OCPL/1.6.0/)
- [simple-1c](https://github.com/ivan816/simple-1c) / [Статья на Хабре](https://habr.com/ru/companies/knopka/articles/314030/)