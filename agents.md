# AGENTS.md (инструкции для LLM-агентов)

Этот репозиторий — исходники расширения 1С:Предприятие 8 `АПРО_ВнешниеЗапросы` (версия `1.03`, совместимость `8.3.27`).
Расширение добавляет HTTP-сервис для выполнения запросов на языке запросов 1С и возврата результата в TSV.

## Что важно помнить

- Это расширение выполняет произвольный текст запроса: изменения валидации/безопасности критичны для защиты базы.
- Основной рабочий код находится в `.bsl` модулях внутри `src/`.
- Имена объектов/функций и префикс расширения фиксированы: `АПРО_ВЗ_`.

## Структура репозитория

- `src/` — выгрузка расширения в файлы (формат `Hierarchical`).
  - `src/HTTPServices/АПРО_ВЗ_HTTPЗапросы/Ext/Module.bsl` — обработчики HTTP и конвертация результата в TSV.
  - `src/CommonModules/МодульJSON/Ext/Module.bsl` — вспомогательное преобразование значений в JSON (пока не используется HTTP-сервисом).
  - `src/Configuration.xml` — метаданные расширения (имя, версия, префикс и т.д.).
- `build/` — собранный артефакт расширения (`.cfe`).
- `publication.yaml` — флаг публикации HTTP-сервиса (используется в окружении публикации).

## HTTP API (контракт)

HTTP-сервис: `АПРО_ВЗ_HTTPЗапросы`, `RootURL = queries`.
При публикации в 1С стандартный путь выглядит как: `/hs/queries/...`.

### `GET /hs/queries/health`

- Ответ: `200`, тело: `{"result":"ok"}`, `Content-Type: application/json`.

### `POST /hs/queries/query`

- `Content-Type: application/json`
- Тело запроса (JSON-объект):
  - `query` (string, обязательно): текст запроса 1С
  - `params` (array, опционально): массив объектов `{ "name": "...", "value": ... }`
- Поведение:
  - читает тело как строку, парсит JSON
  - создает `Запрос`, устанавливает `Запрос.Текст = query`
  - если `params` задан, делает `Запрос.УстановитьПараметр(name, value)`
  - выполняет `Запрос.Выполнить().Выгрузить()`
  - возвращает TSV: первая строка — заголовки колонок, далее строки данных
- Ответ: `200`, `Content-Type: text/tab-separated-values; charset=utf-8`
- Ошибки валидации (например пустое тело, некорректный JSON, нет `query`): `400` + plain-text сообщение.

Пример запроса:
```bash
curl -X POST "http://localhost:8314/hs/queries/query" -H "Content-Type: application/json" -d "{\"query\":\"ВЫБРАТЬ ПЕРВЫЕ 10 Код, Наименование ИЗ Справочник.Номенклатура\"}"
```

## TSV-формат и экранирование

Преобразование в TSV находится в `src/HTTPServices/АПРО_ВЗ_HTTPЗапросы/Ext/Module.bsl`:

- Разделитель — `Символы.Таб`, строки — `Символы.ПС`.
- Значения приводятся к строке через `Строка(Значение)`.
- Экранирование (упрощенное): табы/переводы строк заменяются пробелами, `;` заменяется на `,`.
- Кавычек/escaping по RFC нет — при изменениях сохраняйте обратную совместимость.

## Рабочий процесс разработки (типовой для 1С)

- Открыть базу в конфигураторе/EDT и загрузить расширение из `src/` (или установить артефакт из `build/*.cfe`).
- Правки вносить в модули расширения, затем выгрузить расширение обратно в `src/`.
- После изменений проверять минимум:
  - `GET /hs/queries/health` возвращает `200`
  - `POST /hs/queries/query` выполняет простой `ВЫБРАТЬ ПЕРВЫЕ N ...` и возвращает TSV

## Правила для изменений (для агентов)

- Не меняйте публичные точки интеграции без явной задачи: `RootURL`, имена методов (`query`, `health`), Content-Type, формат TSV.
- Любая новая логика должна быть серверной (HTTP-сервисы исполняются на сервере).
- Обрабатывайте ошибки предсказуемо:
  - ошибки валидации/контракта — `400` и понятный текст
  - ошибки выполнения запроса — не «прятать» молча; лучше добавить контролируемый `500` с минимальными утечками деталей
- Учитывайте безопасность:
  - не добавляйте `Привилегированный` код без необходимости
  - по умолчанию считать, что вызывающий пользователь должен иметь минимальные права (лучше отдельный тех.пользователь на публикации)
  - при задачах на «усиление безопасности» предлагайте ограничения: лимит строк (`ПЕРВЫЕ`), таймауты, запрет небезопасных конструкций, аудит/логирование
